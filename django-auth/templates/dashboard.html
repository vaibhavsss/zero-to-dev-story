{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div id="root"></div>

<script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.2/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<script type="text/babel">
const { useState, useEffect } = React;

const fetchWithAuth = async (url, options = {}) => {
  const token = localStorage.getItem("access_token");
  if (!options.headers) options.headers = {};
  options.headers["Authorization"] = `Bearer ${token}`;

  const res = await fetch(url, options);
  if (res.status === 401) {
    window.location.href = "/login/";
  }
  return res;
};

const Dashboard = () => {
  const [message, setMessage] = useState("Loading...");
  const [users, setUsers] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'asc' });

  useEffect(() => {
    const loadDashboard = async () => {
      try {
        setIsLoading(true);
        const res = await fetchWithAuth("/api/auth/dashboard/");
        const result = await res.json();
        if (res.ok) {
          setMessage(`✅ ${result.message}`);
        } else {
          setMessage(`❌ ${result.detail || "Not authorized"}`);
        }
      } catch (err) {
        setMessage(`⚠️ Error: ${err.message}`);
      }
    };

    const loadUsers = async () => {
      try {
        const res = await fetchWithAuth("/api/auth/users/");
        const data = await res.json();
        setUsers(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setIsLoading(false);
      }
    };

    loadDashboard();
    loadUsers();
  }, []);

  const handleLogout = () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    window.location.href = "/login/";
  };

  const handleSort = (key) => {
    let direction = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });

    const sortedUsers = [...users].sort((a, b) => {
      if (a[key] < b[key]) return direction === 'asc' ? -1 : 1;
      if (a[key] > b[key]) return direction === 'asc' ? 1 : -1;
      return 0;
    });
    setUsers(sortedUsers);
  };

  return (
    <div className="container mx-auto px-6 py-12 max-w-6xl bg-white min-h-screen font-sans">
      <div className="relative bg-white/10 backdrop-blur-xl rounded-2xl shadow-sm p-10 mb-10 border border-gray-100/30 transition-all duration-500 hover:shadow-md">
        <div className="absolute inset-0 rounded-2xl" style={{
          background: 'linear-gradient(135deg, rgba(168,181,162,0.2), rgba(255,255,255,0.1))',
          boxShadow: 'inset 0 1px 4px rgba(255,255,255,0.3)',
        }}></div>
        <h1 className="relative text-4xl font-semibold text-gray-900 mb-4 tracking-tight">Welcome to Your Dashboard</h1>
        <p className="relative text-xl text-gray-700 mb-6 transition-opacity duration-300">{message}</p>
        <button
          onClick={handleLogout}
          className="relative bg-[#A8B5A2]/90 hover:bg-[#A8B5A2]/80 text-white font-medium py-2.5 px-6 rounded-full transition duration-300 transform hover:scale-105 backdrop-blur-sm border border-white/20"
        >
          Sign Out
        </button>
      </div>

      <div className="relative bg-white/10 backdrop-blur-xl rounded-2xl shadow-sm p-10 border border-gray-100/30 transition-all duration-500 hover:shadow-md">
        <div className="absolute inset-0 rounded-2xl" style={{
          background: 'linear-gradient(135deg, rgba(168,181,162,0.2), rgba(255,255,255,0.1))',
          boxShadow: 'inset 0 1px 4px rgba(255,255,255,0.3)',
        }}></div>
        <h2 className="relative text-2xl font-semibold text-gray-900 mb-6 tracking-tight">All Users</h2>
        {isLoading ? (
          <div className="flex justify-center items-center h-32">
            <div className="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-[#A8B5A2]"></div>
          </div>
        ) : error ? (
          <p className="relative text-red-500 font-medium">Error: {error}</p>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full table-auto border-collapse">
              <thead>
                <tr className="bg-white/20 backdrop-blur-sm text-gray-900">
                  <th
                    className="relative px-6 py-4 text-left font-medium cursor-pointer hover:bg-white/30 transition duration-200 tracking-wide"
                    onClick={() => handleSort('id')}
                  >
                    ID {sortConfig.key === 'id' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th
                    className="relative px-6 py-4 text-left font-medium cursor-pointer hover:bg-white/30 transition duration-200 tracking-wide"
                    onClick={() => handleSort('username')}
                  >
                    Username {sortConfig.key === 'username' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                  <th
                    className="relative px-6 py-4 text-left font-medium cursor-pointer hover:bg-white/30 transition duration-200 tracking-wide"
                    onClick={() => handleSort('email')}
                  >
                    Email {sortConfig.key === 'email' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                  </th>
                </tr>
              </thead>
              <tbody>
                {users.map(user => (
                  <tr
                    key={user.id}
                    className="border-b border-gray-100/50 hover:bg-white/20 transition duration-200"
                  >
                    <td className="relative px-6 py-4 text-gray-800">{user.id}</td>
                    <td className="relative px-6 py-4 text-gray-800">{user.username}</td>
                    <td className="relative px-6 py-4 text-gray-800">{user.email}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
};

ReactDOM.render(<Dashboard />, document.getElementById('root'));
</script>
{% endblock %}